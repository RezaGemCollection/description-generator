const VariantParser = require('./src/utils/variantParser');

// Mock the addVariantsBulletPoint function to test the issue
function addVariantsBulletPoint(htmlDescription, productData) {
  try {
    const formattedVariants = VariantParser.formatVariantsForDescription(productData.variants, productData.options);
    
    console.log(`📋 Formatted variants: "${formattedVariants}"`);
    console.log(`📋 Variants length: ${formattedVariants?.length || 0}`);
    console.log(`📋 Is empty: ${!formattedVariants || formattedVariants.trim() === ''}`);
    console.log(`📋 Is Standard: ${formattedVariants === 'Standard'}`);
    
    // If no meaningful variants, return the description as is
    if (!formattedVariants || formattedVariants === 'Standard' || formattedVariants.trim() === '') {
      console.log('❌ No meaningful variants found, returning original HTML');
      return htmlDescription;
    }

    // Create the variants bullet point
    const variantsBullet = `<li>\n<strong>Available Variants:</strong> ${formattedVariants}</li>`;

    // Insert the variants bullet point after the first <ul> tag
    const result = htmlDescription.replace(
      /(<ul>)/,
      `$1\n  ${variantsBullet}`
    );
    
    console.log('✅ Variants bullet point added successfully');
    return result;

  } catch (error) {
    console.error(`Error adding variants bullet point: ${error.message}`);
    return htmlDescription; // Return original if adding variants fails
  }
}

async function testInitialVariantsIssue() {
  console.log('🧪 Testing Initial Variants Issue\n');

  // Sample HTML description (as generated by Gemini without variants)
  const sampleHtml = `
<h2>About Test Diamond Ring</h2>
<p>Beautiful diamond ring with exceptional craftsmanship and timeless elegance.</p>
<ul>
  <li>Exquisite design with premium materials and superior craftsmanship</li>
  <li>Handcrafted with attention to detail and exceptional quality standards</li>
  <li>Expertly crafted by skilled artisans using traditional techniques</li>
  <li>Made with the finest materials and genuine gemstones</li>
  <li>Timeless design that combines elegance with contemporary style</li>
  <li><strong>Verified and Certified by Gemmologist Reza Piroznia</strong></li>
  <li>This product includes a <a href="https://rezagemcollection.ca/policies/refund-policy">7-day money-back guarantee</a></li>
</ul>`;

  console.log('📝 Original HTML (without variants):');
  console.log(sampleHtml);
  console.log('');

  // Test different scenarios for initial product creation
  const scenarios = [
    {
      name: 'Empty variants array',
      productData: {
        title: 'Test Diamond Ring',
        variants: [],
        options: []
      }
    },
    {
      name: 'Single variant with Default Title',
      productData: {
        title: 'Test Diamond Ring',
        variants: [
          { title: 'Default Title', option1: 'Default Title', option2: null, option3: null }
        ],
        options: []
      }
    },
    {
      name: 'Single variant with meaningful title',
      productData: {
        title: 'Test Diamond Ring',
        variants: [
          { title: 'Small / Gold', option1: 'Small', option2: 'Gold', option3: null }
        ],
        options: [
          { name: 'Size', values: ['Small'] },
          { name: 'Material', values: ['Gold'] }
        ]
      }
    },
    {
      name: 'Multiple variants',
      productData: {
        title: 'Test Diamond Ring',
        variants: [
          { title: 'Small / Gold', option1: 'Small', option2: 'Gold', option3: null },
          { title: 'Medium / Gold', option1: 'Medium', option2: 'Gold', option3: null },
          { title: 'Large / Gold', option1: 'Large', option2: 'Gold', option3: null }
        ],
        options: [
          { name: 'Size', values: ['Small', 'Medium', 'Large'] },
          { name: 'Material', values: ['Gold'] }
        ]
      }
    }
  ];

  for (const scenario of scenarios) {
    console.log(`🔄 Scenario: ${scenario.name}`);
    console.log(`   Variants: ${JSON.stringify(scenario.productData.variants.map(v => v.title))}`);
    console.log(`   Options: ${JSON.stringify(scenario.productData.options.map(o => ({ name: o.name, values: o.values })))}`);
    
    try {
      const result = addVariantsBulletPoint(sampleHtml, scenario.productData);
      
      // Check if variants were added
      const hasVariants = result.includes('<strong>Available Variants:</strong>');
      console.log(`   Has variants bullet point: ${hasVariants}`);
      
      if (hasVariants) {
        const variantsMatch = result.match(/<li>\s*<strong>Available Variants:<\/strong>.*?<\/li>/);
        console.log(`   Variants added: ${variantsMatch[0].replace(/<[^>]*>/g, '')}`);
      } else {
        console.log(`   ❌ No variants bullet point added`);
      }
      
      console.log('');
    } catch (error) {
      console.log(`   Error: ${error.message}`);
      console.log('');
    }
  }

  console.log('🔧 Issue Analysis:');
  console.log('- When products are first created, variants might be empty or "Default Title"');
  console.log('- The current logic skips adding variants bullet point in these cases');
  console.log('- This causes the initial description to be missing the variants information');
  console.log('- Only when variants are updated later does the bullet point get added');
  console.log('');
  console.log('💡 Solution:');
  console.log('- Modify the logic to always add a variants bullet point');
  console.log('- For empty/default variants, show "Standard" or "Single Variant"');
  console.log('- This ensures consistency between initial creation and updates');
}

// Run the test
if (require.main === module) {
  testInitialVariantsIssue();
}

module.exports = { testInitialVariantsIssue };
